import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from datetime import datetime, timedelta
import google.generativeai as genai
import os

# -------- CONFIGURACI√ìN DE LA P√ÅGINA --------
st.set_page_config(page_title="An√°lisis Financiero & Descripci√≥n IA", page_icon="üìà", layout="wide")

# -------- ESTILOS PERSONALIZADOS --------
st.markdown("""
    <style>
        html, body, [class*="css"] {
            background-color: #000000;
            color: #000000;
        }
        .stButton>button {
            color: white;
            background: linear-gradient(90deg, #007BFF, #00D4FF);
            border: none;
            padding: 0.6em 2em;
            font-weight: bold;
            border-radius: 8px;
        }
        .stTextInput>div>div>input {
            font-size: 18px;
            padding: 10px;
            border-radius: 12px;
            border: 2px solid #ccc;
            text-align: center;
            color: #333;
        }
        .stMarkdown {
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            color: #black;
        }
    </style>
""", unsafe_allow_html=True)

# -------- CONEXI√ìN A GEMINI (GOOGLE GENAI) --------
genai.configure(api_key="AIzaSyAL8weo8gSEtaBtrs7WDoLAyIS42Id02M4")  
model = genai.GenerativeModel("gemini-1.5-flash")

# -------- SIDEBAR --------
with st.sidebar:
    st.markdown("""
        <style>
            .sidebar-title {
                font-size: 26px;
                font-weight: 800;
                color: #00C2FF;
                margin-bottom: 5px;
                font-family: 'Segoe UI', sans-serif;
            }
            .sidebar-sub {
                font-size: 16px;
                color: #black;
                font-style: italic;
                margin-bottom: 15px;
            }
            .sidebar-section {
                font-size: 18px;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 10px;
                color: #black;
            }
        </style>
        <div class='sidebar-title'>üìä An√°lisis Financiero </div>
        <div class='sidebar-sub'>Potenciado con IA</div>
    """, unsafe_allow_html=True)

    # Ticker Input
    st.markdown("<div class='sidebar-section'>üíº Ticker de la Empresa</div>", unsafe_allow_html=True)
    ticker = st.text_input("Ingresa el s√≠mbolo burs√°til de tu elecci√≥n (Ej. AAPL)", "AAPL")

    # Fechas
    st.markdown("<div class='sidebar-section'>üìÜ Fechas a Consultar</div>", unsafe_allow_html=True)
    col1, col2 = st.columns(2)
    with col1:
        start_date = st.date_input("Desde:", datetime.today() - timedelta(days=5*365))
    with col2:
        end_date = st.date_input("Hasta:", datetime.today())

    # Opciones adicionales
    st.markdown("<div class='sidebar-section'>‚öôÔ∏è Opciones Adicionales</div>", unsafe_allow_html=True)
    show_comparativa = st.checkbox("Comparar con sector", value=True)
    show_descripcion = st.checkbox("Mostrar descripci√≥n de la empresa", value=True)
    show_historico = st.checkbox("Ver hist√≥rico de precios", value=True)

    # Botones decorativos
    st.markdown("<div class='sidebar-section'>üìÅ Exportar</div>", unsafe_allow_html=True)
    st.button("‚¨áÔ∏è Descargar CSV")
    st.button("üìÑ Generar PDF")

    # Submit
    st.markdown("---")
    submit = st.button("üöÄ Generar An√°lisis")

    st.caption("¬© 2025 VanniaAPP - Todos los derechos reservados.")


# -------- FUNCI√ìN DE VALIDACI√ìN --------
def validar_ticker(ticker):
    try:
        data = yf.Ticker(ticker)
        info = data.info
        if "shortName" in info:
            return info
    except:
        return None

# -------- FLUJO PRINCIPAL --------
if submit:
    info = validar_ticker(ticker)

    if info:
        st.title(f"üìä **An√°lisis Financiero de {info['shortName']}** üìà")
        st.markdown(f"""
        **Sector:** {info.get('sector', 'N/A')}  
        **Industria:** {info.get('industry', 'N/A')}
        """)

        # -------- DESCRIPCI√ìN GENERADA POR IA --------
        with st.spinner("üß† **Buscando informaci√≥n importante de la empresa...**"):
            prompt = f"Resume profesionalmente a qu√© se dedica la empresa {info['longName']}, cuyo ticker es {ticker}. Dame un resumen profesional de la empresa."
            try:
                response = model.generate_content(prompt)
                st.markdown("### üí° **Descripci√≥n de la Empresa**")
                st.write(response.text)
            except Exception as e:
                st.error(f"‚ùå **Error al generar la descripci√≥n con IA: {str(e)}**")

        # -------- DATOS HIST√ìRICOS --------
        df = yf.download(ticker, start=start_date, end=end_date)
        if 'Adj Close' in df.columns:
            df['Price'] = df['Adj Close']
        else:
            df['Price'] = df['Close']
        df.fillna(method='ffill', inplace=True)

        # -------- EMPRESAS DEL MISMO SECTOR --------
        sector_tickers = {
            'Technology': ['AAPL', 'MSFT', 'GOOGL', 'NVDA', 'AMZN'],
            'Healthcare': ['JNJ', 'PFE', 'MRK', 'GILD', 'ABBV'],
            'Financials': ['JPM', 'GS', 'BAC', 'WFC', 'C'],
            'Consumer Discretionary': ['DIS', 'MCD', 'NKE', 'TGT', 'AMZN'],
            'Other': []
        }
        tickers_comparativa = sector_tickers.get(info.get('sector', 'Other'), [])
        sector_data = {}

        for sec_ticker in tickers_comparativa:
            data = yf.download(sec_ticker, start=start_date, end=end_date)
            if 'Adj Close' in data.columns:
                data['Price'] = data['Adj Close']
            else:
                data['Price'] = data['Close']
            data.fillna(method='ffill', inplace=True)
            sector_data[sec_ticker] = data

        # -------- GR√ÅFICO HIST√ìRICO PRINCIPAL --------
        st.markdown("### üìâ Evoluci√≥n Hist√≥rica de Precios")
        if not df.empty:
            fig = go.Figure()
            fig.add_trace(go.Scatter(
                x=df.index,
                y=df['Price'],
                mode="lines",
                name=f"{ticker} (Cierre Ajustado)",
                line=dict(color="#E91E63")
            ))
            fig.update_layout(
                title=f"Precio hist√≥rico de {ticker.upper()}",
                xaxis_title="Fecha",
                yaxis_title="Precio en USD",
                xaxis=dict(tickformat="%b %Y", tickangle=45),
                template="plotly_white",
                height=480
            )
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.warning("No se hallaron datos suficientes para mostrar el gr√°fico.")

        st.divider()

        # ----- AN√ÅLISIS T√âCNICO -----------
        st.markdown("### üìä An√°lisis T√©cnico")

        # C√°lculo de medias m√≥viles
        df['SMA_20'] = df['Price'].rolling(window=20).mean()
        df['SMA_50'] = df['Price'].rolling(window=50).mean()

        # RSI (Relative Strength Index)
        delta = df['Price'].diff()
        gain = delta.where(delta > 0, 0)
        loss = -delta.where(delta < 0, 0)

        avg_gain = gain.rolling(window=14).mean()
        avg_loss = loss.rolling(window=14).mean()

        rs = avg_gain / avg_loss
        df['RSI'] = 100 - (100 / (1 + rs))

        # Gr√°fico con SMA
        fig_ta = go.Figure()
        fig_ta.add_trace(go.Scatter(x=df.index, y=df['Price'], mode='lines', name='Precio'))
        fig_ta.add_trace(go.Scatter(x=df.index, y=df['SMA_20'], mode='lines', name='SMA 20 d√≠as'))
        fig_ta.add_trace(go.Scatter(x=df.index, y=df['SMA_50'], mode='lines', name='SMA 50 d√≠as'))
        fig_ta.update_layout(title="üìà Precio vs Medias M√≥viles", template="plotly_white")
        st.plotly_chart(fig_ta, use_container_width=True)

        # Gr√°fico RSI
        fig_rsi = go.Figure()
        fig_rsi.add_trace(go.Scatter(x=df.index, y=df['RSI'], mode='lines', name='RSI'))
        fig_rsi.update_layout(title="üìâ √çndice de Fuerza Relativa (RSI)", yaxis=dict(range=[0, 100]), template="plotly_white")
        st.plotly_chart(fig_rsi, use_container_width=True)

        # -------- CONCLUSI√ìN AUTOM√ÅTICA DEL AN√ÅLISIS T√âCNICO --------
        st.markdown("### üß† Conclusi√≥n del An√°lisis T√©cnico")

        ultima_rsi = df['RSI'].iloc[-1]
        sma_20 = df['SMA_20'].iloc[-1]
        sma_50 = df['SMA_50'].iloc[-1]
        ultimo_precio = df['Price'].iloc[-1]

        conclusiones = []

        # RSI Interpretation
        if ultima_rsi < 30:
            conclusiones.append("üîµ El RSI indica que la acci√≥n est√° en zona de **sobreventa** (posible rebote al alza).")
        elif ultima_rsi > 70:
            conclusiones.append("üî¥ El RSI indica una **sobrecompra** (riesgo de correcci√≥n a la baja).")
        else:
            conclusiones.append("üü° El RSI se encuentra en zona neutral, sin se√±ales claras de compra o venta.")

        # SMA Interpretation
        if sma_20 > sma_50:
            conclusiones.append("üìà La media m√≥vil de 20 d√≠as est√° por encima de la de 50 d√≠as: se√±al de **tendencia alcista**.")
        elif sma_20 < sma_50:
            conclusiones.append("üìâ La media m√≥vil de 20 d√≠as est√° por debajo de la de 50 d√≠as: se√±al de **tendencia bajista**.")
        else:
            conclusiones.append("‚ûñ Las medias m√≥viles est√°n alineadas: **no hay tendencia clara**.")

        # Comparaci√≥n de precio actual vs. medias m√≥viles
        if ultimo_precio > sma_20:
            conclusiones.append("‚úÖ El precio actual est√° por encima de su media de corto plazo (SMA 20), lo que sugiere **fortaleza reciente**.")
        else:
            conclusiones.append("‚ö†Ô∏è El precio actual est√° por debajo de su media de corto plazo (SMA 20), lo que podr√≠a indicar **debilidad en el corto plazo**.")

        # Mostrar conclusiones
        for c in conclusiones:
            st.markdown(c)

        # -------- SIMULACI√ìN MONTECARLO --------
        st.markdown("### üîÆ Simulaci√≥n Monte Carlo - Predicci√≥n a 30 d√≠as")

        # N√∫mero de simulaciones y d√≠as
        num_simulaciones = 500
        num_dias = 30

        # Calcular log-returns
        df['log_return'] = np.log(df['Price'] / df['Price'].shift(1))
        media = df['log_return'].mean()
        volatilidad = df['log_return'].std()

        # Precio inicial
        precio_actual = df['Price'].iloc[-1]

        # Simular trayectorias
        simulaciones = np.zeros((num_dias, num_simulaciones))

        for sim in range(num_simulaciones):
            precio = precio_actual
            for dia in range(num_dias):
                shock = np.random.normal(loc=media, scale=volatilidad)
                precio *= np.exp(shock)
                simulaciones[dia, sim] = precio

        # Crear gr√°fico
        fig_mc = go.Figure()
        for i in range(num_simulaciones):
            fig_mc.add_trace(go.Scatter(
                x=list(range(1, num_dias+1)),
                y=simulaciones[:, i],
                mode='lines',
                line=dict(width=0.5),
                opacity=0.2,
                showlegend=False
            ))

        fig_mc.update_layout(
            title="üîÅ Proyecciones de Precio (Monte Carlo)",
            xaxis_title="D√≠as en el Futuro",
            yaxis_title="Precio Estimado (USD)",
            template="plotly_white",
            height=500
        )
        st.plotly_chart(fig_mc, use_container_width=True)

        # -------- CONCLUSI√ìN DE LA SIMULACI√ìN --------
        st.markdown("### üìå Conclusi√≥n de la Simulaci√≥n")

        precio_finales = simulaciones[-1]
        p_min = round(np.percentile(precio_finales, 5), 2)
        p_max = round(np.percentile(precio_finales, 95), 2)
        p_median = round(np.median(precio_finales), 2)

        st.markdown(f"""
        üß† Basado en {num_simulaciones} simulaciones de Monte Carlo:
        - üìâ Hay un 90% de probabilidad de que el precio est√© entre **${p_min}** y **${p_max}** en 30 d√≠as.
        - üìç El precio mediano estimado es **${p_median}**.
        """)

        # An√°lisis sencillo de tendencia esperada
        if p_median > precio_actual:
            st.success("üìà Las simulaciones sugieren una **tendencia alcista** en el pr√≥ximo mes.")
        elif p_median < precio_actual:
            st.warning("üìâ Las simulaciones indican una posible **correcci√≥n o baja** en el precio.")
        else:
            st.info("‚ûñ Las simulaciones no muestran una direcci√≥n clara del precio.")


        # -------- COMPARATIVA CON EMPRESAS DEL SECTOR --------
        st.markdown("### üè¢ Tabla Comparativa con Empresas del Sector")

        fig_sector = go.Figure()
        for sec_ticker, sec_df in sector_data.items():
            if not sec_df.empty:
                fig_sector.add_trace(go.Scatter(
                    x=sec_df.index,
                    y=sec_df['Price'],
                    mode='lines',
                    name=f'{sec_ticker}'
                ))

        # Agrega el ticker principal
        if not df.empty:
            fig_sector.add_trace(go.Scatter(
                x=df.index,
                y=df['Price'],
                mode='lines',
                name=f'{ticker} (Principal)',
                line=dict(color='red', width=2)
            ))
            fig_sector.update_layout(
                title=f"Comparativa de {ticker.upper()} vs empresas del sector {info.get('sector', 'N/A')}",
                xaxis_title="Fecha",
                yaxis_title="Precio Ajustado (USD)",
                template="plotly_dark",
                legend_title="Empresas",
                xaxis=dict(showgrid=True, zeroline=True),
                yaxis=dict(showgrid=True, zeroline=True),
                height=500
            )
            st.plotly_chart(fig_sector, use_container_width=True)
        else:
            st.error("‚ùå No se encontraron datos v√°lidos para el ticker principal.")
    else:
        st.error("‚ùå **Ticker inv√°lido. Por favor, verifica el s√≠mbolo ingresado.**")
    
    # ------ RENDIMIENTOS ANUALIZADOS ------
    st.markdown("### üìà Rendimientos Anualizados")

    fecha_actual = df.index[-1]
    precios = df['Price']

    def calcular_rendimiento_anualizado(fecha_objetivo):
        df_filtrado = df[df.index >= fecha_objetivo]
        if not df_filtrado.empty:
            precio_inicio = df_filtrado['Price'].iloc[0]
            precio_final = precios.iloc[-1]
            a√±os = (df_filtrado.index[-1] - df_filtrado.index[0]).days / 365.25
            return round(((precio_final / precio_inicio) ** (1 / a√±os) - 1) * 100, 2)
        return None

    rendimiento_1a = calcular_rendimiento_anualizado(fecha_actual - pd.DateOffset(years=1))
    rendimiento_3a = calcular_rendimiento_anualizado(fecha_actual - pd.DateOffset(years=3))
    rendimiento_5a = calcular_rendimiento_anualizado(fecha_actual - pd.DateOffset(years=5))

    col1, col2, col3 = st.columns(3)
    col1.metric("üîÅ √öltimo a√±o", f"{rendimiento_1a}%" if rendimiento_1a else "N/A")
    col2.metric("üìä √öltimos 3 a√±os", f"{rendimiento_3a}%" if rendimiento_3a else "N/A")
    col3.metric("üìà √öltimos 5 a√±os", f"{rendimiento_5a}%" if rendimiento_5a else "N/A")

    # ------ VOLATILIDAD RIESGO ---------
    st.markdown("### ‚ö†Ô∏è Volatilidad Anualizada")

    # Aseg√∫rate de tener log_return en el DataFrame
    if 'log_return' not in df.columns:
        df['log_return'] = np.log(df['Price'] / df['Price'].shift(1))

    vol_diaria = df['log_return'].std()
    vol_anual = vol_diaria * np.sqrt(252)

    st.metric("üìâ Volatilidad Anualizada", f"{round(vol_anual * 100, 2)}%")

    # -------- RECOMENDACI√ìN FINAL --------
    st.markdown("## üßæ Recomendaci√≥n Final")

    # Variables clave del an√°lisis
    precio_actual = df['Price'].iloc[-1]
    r1 = rendimiento_1a or 0
    r3 = rendimiento_3a or 0
    r5 = rendimiento_5a or 0
    tendencia_tecnica = "neutral"

    if sma_20 > sma_50 and ultima_rsi < 70:
        tendencia_tecnica = "alcista"
    elif sma_20 < sma_50 and ultima_rsi > 30:
        tendencia_tecnica = "bajista"

    riesgo = vol_anual
    sim_min = p_min
    sim_max = p_max
    sim_mediana = p_median

    # Generar recomendaci√≥n
    if r1 > 0 and tendencia_tecnica == "alcista" and sim_mediana > precio_actual and riesgo < 0.35:
        mensaje = f"""
        ‚úÖ **La empresa {info['shortName']} muestra se√±ales positivas para los inversionistas.**  
        Presenta un crecimiento anual de {r1}% en el √∫ltimo a√±o, una tendencia t√©cnica alcista y una proyecci√≥n favorable en los pr√≥ximos 30 d√≠as seg√∫n la simulaci√≥n de Monte Carlo (precio estimado mediano: ${sim_mediana}).  
        La volatilidad se mantiene en un rango razonable de {round(riesgo*100,2)}%, lo que la convierte en una opci√≥n atractiva de inversi√≥n a mediano plazo.
        """
    elif r1 < 0 and tendencia_tecnica == "bajista" and sim_mediana < precio_actual:
        mensaje = f"""
        ‚ö†Ô∏è **Actualmente, {info['shortName']} presenta se√±ales de cautela para nuevos inversionistas.**  
        El rendimiento anualizado ha sido negativo ({r1}%), la tendencia t√©cnica es bajista y el modelo de predicci√≥n estima que el precio podr√≠a seguir descendiendo en las pr√≥ximas semanas.  
        Adem√°s, la volatilidad anualizada del {round(riesgo*100,2)}% sugiere un riesgo elevado. Puede ser prudente esperar una mejor oportunidad.
        """
    else:
        mensaje = f"""
        ‚ÑπÔ∏è **La empresa {info['shortName']} presenta se√±ales mixtas.**  
        Aunque ha tenido un rendimiento anual de {r1}%, la tendencia t√©cnica es {tendencia_tecnica}, y la simulaci√≥n de Monte Carlo proyecta un precio estimado mediano de ${sim_mediana}, que est√°{' por encima' if sim_mediana > precio_actual else ' por debajo'} del valor actual.  
        Con una volatilidad del {round(riesgo*100,2)}%, se recomienda analizar el perfil de riesgo del inversionista antes de tomar una decisi√≥n.
        """

    st.markdown(mensaje)

    # -------- PIE DE P√ÅGINA --------
    st.markdown("""---""")

    st.markdown("""
    <div style='text-align: center; font-size: 16px; padding-top: 20px; color: #black;'>
    Hecho con üíô por <strong>Vannia Fernanda Martin Medina</strong> ¬∑ 2025<br>
    Esta app combina an√°lisis financiero tradicional üìä con el poder de la IA ü§ñ<br>
    <em>Se sugiere que la informaci√≥n aqu√≠ mostrada se utilice con responsabilidad.</em><br><br>
    üìß ¬øSugerencias o mejoras? Jajajaja no creo! | Me merezco un 10 Profe! </em><br><br>
    Le deseo Bonitas Vacaciones üèùÔ∏è‚òÄÔ∏èüåä
    </div>
    """, unsafe_allow_html=True)

    

    




